<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI语音面试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        neutral: '#F5F7FA',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-shadow {
                box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
            }
            .btn-shadow-red {
                box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.4);
            }
            .pulse-animation {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .message-item {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-microphone text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-dark">AI语音面试</h1>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 状态显示区 -->
        <div class="mb-6 bg-white rounded-lg shadow-sm p-4 flex items-center">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-300 mr-3"></div>
            <p id="statusText" class="text-gray-600">准备就绪，请点击下方按钮开始录音</p>
        </div>
        <div class="mb-6 bg-white rounded-lg shadow-sm p-4">
            <h2 class="text-lg font-semibold text-dark mb-3">个人信息</h2>
            <textarea 
                id="userInfo" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                rows="3" 
                placeholder="请输入您的个人信息（如姓名、职位、联系方式等）"
            ></textarea>
        </div>
        <!-- 文本显示区 -->
        <div id="chat-container" class="bg-white rounded-lg shadow-sm p-4 mb-6 h-[500px] overflow-y-auto scrollbar-hide">
            <div class="flex flex-col space-y-6" style="margin-bottom: 20px;">
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0">
                        <i class="fa fa-info-circle"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 rounded-tl-none max-w-[80%]">
                        <p class="text-gray-800">欢迎使用AI语音面试！点击下方麦克风按钮开始个人介绍。</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 语音输入区域 -->
        <div class="bg-white rounded-lg shadow-sm p-4 flex flex-col space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="voice-level" class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="voice-level-indicator" class="h-full bg-primary w-0 transition-all duration-150"></div>
                    </div>
                    <span id="voice-level-text" class="text-sm text-gray-500">音量: 0</span>
                </div>
                <button id="clear-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    <i class="fa fa-trash-o mr-1"></i> 清空文本
                </button>
            </div>
            
            <div class="flex justify-center">
                <button id="recordBtn" class="w-20 h-20 rounded-full bg-primary text-white flex items-center justify-center shadow-lg hover:bg-primary/90 active:scale-95 transition-all">
                    <i class="fa fa-microphone text-3xl"></i>
                </button>
            </div>
            
            <div class="text-center text-sm text-gray-500">
                <p>说话时请保持适中语速和音量</p>
            </div>
        </div>
    </main>
    

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>© 2025 AI语音面试 | WebSocket连接至 ws://localhost:8080</p>
        </div>
    </footer>

    <script>
        let mediaRecorder;
        let audioStream;
        let isRecording = false;
        let ws;
        let audioContext;
        let analyser;
        let animationFrameId;
        const recordBtn = document.getElementById('recordBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const chatContainer = document.getElementById('chat-container');
        const clearBtn = document.getElementById('clear-btn');
        const voiceLevelIndicator = document.getElementById('voice-level-indicator');
        const voiceLevelText = document.getElementById('voice-level-text');


        let shouldAutoRestart = false; // 是否应该在音频播放完毕后自动重启录音
        let isProcessing = false; // 是否正在处理中（等待响应或播放音频）

        let audioPlayer = new Audio();
        let isUserInteracted = false; // 用于处理自动播放限制

        function playAudio(url) {
            if(!isUserInteracted) return;
            
            audioPlayer.pause();
            audioPlayer.src = url;
            isProcessing = true; // 标记为处理中
            
            audioPlayer.play().catch(error => {
                console.error('音频播放失败:', error);
                isProcessing = false;
                checkAutoRestart(); // 检查是否需要自动重启
            });
            
            audioPlayer.onended = () => {
                isProcessing = false;
                checkAutoRestart(); // 音频播放结束，检查是否需要自动重启
            };
        }


        function checkAutoRestart() {
            // 如果应该自动重启且不处于处理中状态
            if(shouldAutoRestart && !isProcessing) {
                isSilent=false;
                shouldAutoRestart = false;
                startRealTimeAudio(); // 自动重启录音
            }
        }


        // 初始化WebSocket连接
        function initWebSocket() {
            try {
                ws = new WebSocket('ws://172.22.122.255:8080');
                
                ws.onopen = () => {
                    console.log('WebSocket连接已建立');
                    updateConnectionStatus(true);
                };
                
                ws.onclose = (event) => {
                    console.log('WebSocket连接已关闭', event);
                    updateConnectionStatus(false);
                    
                    if (isRecording) {
                        stopRealTimeAudio();
                    }
                    
                    // 尝试重新连接
                    setTimeout(initWebSocket, 3000);
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('收到消息:', data);
                        
                        if(data.role === "user" && data.content?.result) {
                            const isIncremental = data.content?.is_incremental || false;
                            updateMessage(data.content.result, true, isIncremental);
                        }
                        else if(data.role === "assistant" && data.content) {
                            updateMessage(data.content, false);
                            
                            if(data.audio_url) {
                                playAudio(data.audio_url);
                                shouldAutoRestart = true; // 标记需要自动重启
                            } else {
                                // 没有音频时直接重启
                                shouldAutoRestart = true;
                                checkAutoRestart();
                            }
                        }
                    } catch (e) {
                        console.log('收到非JSON消息:', event.data);
                    }
                };

                
                ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('WebSocket初始化失败:', error);
                updateConnectionStatus(false);
            }
        }

        // 更新连接状态UI
        function updateConnectionStatus(isConnected) {
            if (isConnected) {
                statusDot.classList.replace('bg-gray-300', 'bg-green-500');
                statusText.textContent = '已连接到服务器';
            } else {
                statusDot.classList.replace('bg-green-500', 'bg-gray-300');
                statusText.textContent = '未连接到服务器';
            }
        }

        // 在script标签中添加这些变量
        let currentMessageId = null;
        let currentMessageElement = null;

        // 更新消息显示函数
        function updateMessage(text, isUser = false, isIncremental = false) {
            // 如果是增量更新且当前有活跃消息
            if (isIncremental && currentMessageElement) {
                currentMessageElement.querySelector('p').textContent = text;
            } 
            // 否则创建新消息
            else {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start ${isUser ? 'justify-end' : ''} mb-4`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = isUser ? 
                    'bg-secondary/10 text-gray-800 rounded-lg p-3 rounded-tr-none max-w-[80%]' :
                    'bg-gray-100 text-gray-800 rounded-lg p-3 rounded-tl-none max-w-[80%]';
                
                const textP = document.createElement('p');
                textP.textContent = text;
                contentDiv.appendChild(textP);
                messageDiv.appendChild(contentDiv);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // 如果是用户消息，保存引用用于增量更新
                if (isUser) {
                    currentMessageElement = contentDiv;
                }
            }
        }


        // 添加消息到对话区
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start ' + (isUser ? 'justify-end' : '');
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = isUser ? 
                'w-8 h-8 rounded-full bg-secondary/20 flex items-center justify-center text-secondary mr-3 flex-shrink-0' :
                'w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0';
            
            const icon = isUser ? '<i class="fa fa-user"></i>' : '<i class="fa fa-comment"></i>';
            avatarDiv.innerHTML = icon;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = isUser ? 
                'bg-secondary/10 text-gray-800 rounded-lg p-3 rounded-tr-none max-w-[80%]' :
                'bg-gray-100 text-gray-800 rounded-lg p-3 rounded-tl-none max-w-[80%]';
            
            const textP = document.createElement('p');
            textP.textContent = text;
            contentDiv.appendChild(textP);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 清空对话区
        function clearChat() {
            chatContainer.innerHTML = `
                <div class="flex items-start message-item">
                    <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0">
                        <i class="fa fa-info-circle"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 rounded-tl-none max-w-[80%]">
                        <p class="text-gray-800">欢迎使用语音转文本功能！点击下方麦克风按钮开始录音，您的语音将被转换为文字显示在这里。</p>
                    </div>
                </div>
            `;
        }

        // 更新语音音量指示器
        function updateVoiceLevel(level) {
            const percentage = Math.min(100, Math.max(0, level * 100));
            voiceLevelIndicator.style.width = `${percentage}%`;
            voiceLevelText.textContent = `音量: ${Math.round(percentage)}`;
        }

        let noiseLevel = 0;
        let isCalibrating = false;
        const CALIBRATION_TIME = 1000; // 1秒噪声校准时间
        const SILENCE_TIMEOUT = 2000; // 1秒无语音自动停止
        let lastVoiceTime = 0; // 必须初始化


        // 分析音频数据
        let isSilent = false;

        function analyzeAudio() {
            if (!analyser || !isRecording) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i] * dataArray[i];
            }
            const rms = Math.sqrt(sum / dataArray.length);
            const level = rms / 255;
            
            updateVoiceLevel(level);
            
            const currentTime = Date.now();
            console.log("voice: ", level, "currentTime: ", currentTime, "lastVoiceTime: ", lastVoiceTime, "isSilent: ", isSilent)
            if (level > 0.3) { // 检测到声音
                lastVoiceTime = currentTime;
                
                if (isSilent && ws && ws.readyState === WebSocket.OPEN) {
                    const userInfo = document.getElementById('userInfo').value.trim();
            
                    ws.send(JSON.stringify({
                        "status": "say",
                        "api_key": "bfb7ab5723998050f",
                        "user_info": userInfo
                    }));
                    isSilent = false;
                    statusText.textContent = '正在录音，请说话...';
                }
            } 
            // 检测到静音超时
            else if (currentTime - lastVoiceTime > SILENCE_TIMEOUT && !isSilent) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        "status": "over"
                    }));
                    isSilent = true;
                    isProcessing = true; // 标记为处理中
                    statusText.textContent = '正在生成问题...';
                    stopRealTimeAudio(false); // 停止录音但不发送over消息
                }
            }
            
            animationFrameId = requestAnimationFrame(analyzeAudio);
        }

        // 启动录音并实时传输
        async function startRealTimeAudio() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }
          
    
            const userInfo = document.getElementById('userInfo').value.trim();
            ws.send(JSON.stringify({
                "status": "say",
                "api_key": "bce-v3/ALTAK-jbx93vI0G3vWf6w0GD5Fu/cd5fb861f893943ac90762fbfb7ab5723998050f",
                "user_info": userInfo
            }));
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1
                        }
                    });
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 64;
                    analyser.smoothingTimeConstant = 0.3;
                    
                    const samplesPer160ms = 2048;
                    const processor = audioContext.createScriptProcessor(samplesPer160ms, 1, 1);

                    processor.onaudioprocess = (e) => {
                        // 只有在录音状态下才发送音频数据
                        if (ws.readyState === WebSocket.OPEN && isRecording) {
                            const pcmData = e.inputBuffer.getChannelData(0);
                            const pcm16 = new Int16Array(pcmData.length);
                            for (let i = 0; i < pcmData.length; i++) {
                                pcm16[i] = Math.max(-32768, Math.min(32767, pcmData[i] * 32768));
                            }
                            ws.send(pcm16.buffer);
                        }
                    };
                    
                    source.connect(analyser);
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                    
                    audioStream = {
                        audioContext,
                        stream,
                        processor,
                        source
                    };
                }
                
                isRecording = true;
                lastVoiceTime = Date.now();
                recordBtn.innerHTML = '<i class="fa fa-stop text-3xl"></i>';
                recordBtn.classList.replace('bg-primary', 'bg-red-500');
                statusText.textContent = '正在录音，请说话...';
                
                analyzeAudio();

                currentMessageId = Date.now();
                currentMessageElement = null;
                
            } catch (error) {
                console.error('录音启动失败:', error);
                statusText.textContent = '无法访问麦克风';
            }
        }

        // 停止录音
        function stopRealTimeAudio(sendStopMessage = true) {
            if (sendStopMessage && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    "status": "over"
                }));
            }
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            isRecording = false;
            recordBtn.innerHTML = '<i class="fa fa-microphone text-3xl"></i>';
            recordBtn.classList.replace('bg-red-500', 'bg-primary');
            statusText.textContent = isProcessing ? '正在生成问题...' : '已连接到服务器';
            
            // 重置音量指示器
            voiceLevelIndicator.style.width = '0%';
            voiceLevelText.textContent = '音量: 0';

            currentMessageId = null;
            currentMessageElement = null;
        }

        window.addEventListener('load', () => {
            // 检查媒体设备支持
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusText.textContent = '您的浏览器不支持语音功能';
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            initWebSocket();
        });

        // 事件监听器
        recordBtn.addEventListener('click', (e) => {
            isUserInteracted = true;
            e.preventDefault();
            
            // 如果正在处理中，不允许操作
            if(isProcessing) {
                return;
            }
            
            if (isRecording) {
                stopRealTimeAudio();
            } else {
                startRealTimeAudio();
            }
        });

        clearBtn.addEventListener('click', clearChat);

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            if (isRecording) {
                stopRealTimeAudio();
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
        });

        // 页面加载时初始化WebSocket
        window.addEventListener('load', initWebSocket);
    </script>
</body>
</html>