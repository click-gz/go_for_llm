<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>百度AI语音对话助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.10.0/css/all.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#0FC6C2',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-microphone text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-dark">百度AI语音对话助手</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <i class="fa fa-moon-o text-gray-600"></i>
        </button>
        <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <i class="fa fa-cog text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 状态显示区 -->
    <div class="mb-6 bg-white rounded-lg shadow-sm p-4 flex items-center">
      <div id="status-icon" class="w-3 h-3 rounded-full bg-gray-300 mr-3 animate-pulse"></div>
      <p id="status-text" class="text-gray-600">准备就绪，请点击下方按钮开始对话</p>
    </div>

    <!-- 对话历史 -->
    <div id="chat-container" class="bg-white rounded-lg shadow-sm p-4 mb-6 h-[500px] overflow-y-auto scrollbar-hide">
      <div class="flex flex-col space-y-6">
        <!-- 系统消息 -->
        <div class="flex items-start">
          <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0">
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 rounded-tl-none max-w-[80%] mb-4">
            <p class="text-gray-800">欢迎使用百度AI语音对话助手！点击下方麦克风按钮开始语音对话，再次点击停止录音。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 语音输入区域 -->
    <div class="bg-white rounded-lg shadow-sm p-4 flex flex-col space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div id="voice-level" class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
            <div id="voice-level-indicator" class="h-full bg-primary w-0 transition-all duration-150"></div>
          </div>
          <span id="voice-level-text" class="text-sm text-gray-500">音量: 0</span>
        </div>
        <div class="flex items-center space-x-2">
          <button id="clear-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            <i class="fa fa-trash-o mr-1"></i> 清空对话
          </button>
          <button id="audio-output-toggle" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" disabled>
            <i class="fa fa-volume-off mr-1"></i> 语音输出(已禁用)
          </button>
        </div>
      </div>
      
      <div class="flex justify-center">
        <button id="record-btn" class="w-20 h-20 rounded-full bg-primary text-white flex items-center justify-center shadow-lg hover:bg-primary/90 active:scale-95 transition-all">
          <i class="fa fa-microphone text-3xl"></i>
        </button>
      </div>
      
      <div class="text-center text-sm text-gray-500">
        <p>当前使用模拟语音识别，说话时请保持适中语速和音量</p>
      </div>
    </div>
  </main>

  <!-- 设置模态框 -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden transform transition-all">
      <div class="bg-primary text-white p-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">设置</h2>
        <button id="close-settings" class="text-white hover:text-gray-200">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">百度API设置</label>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">API Key</label>
              <input id="api-key" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="输入百度API Key">
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Secret Key</label>
              <input id="secret-key" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="输入百度Secret Key">
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">WebSocket设置</label>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">服务器地址</label>
              <input id="ws-url" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="ws://localhost:5000" value="ws://localhost:5000">
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">语音设置</label>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">ASR 引擎</label>
              <select id="asr-engine" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" disabled>
                <option value="baidu">百度ASR(已禁用)</option>
                <option value="mock">模拟识别</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">TTS 声音</label>
              <select id="tts-voice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" disabled>
                <option value="female">女声(已禁用)</option>
                <option value="male">男声(已禁用)</option>
                <option value="child">儿童声(已禁用)</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="auto-play" class="mr-2">
            <span>自动播放回复语音</span>
          </label>
        </div>
      </div>
      <div class="bg-gray-50 p-4 flex justify-end">
        <button id="save-settings" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          保存设置
        </button>
      </div>
    </div>
  </div>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2025 百度AI语音对话助手 | 当前使用模拟语音识别，WebSocket连接至 ws://localhost:5000</p>
    </div>
  </footer>

  <script>
    // 改进的状态管理
    let chatState = {
        currentStream: {
            active: false,
            content: '',

            element: null,
            messageId: null
        },
        messages: []
    };
    
    // 消息ID生成器
    let messageIdCounter = 0;
    function generateMessageId() {
        return `msg-${Date.now()}-${++messageIdCounter}`;
    }
    
    // 全局变量
    let isRecording = false;
    let audioContext = null;
    let mediaStream = null;
    let analyser = null;
    let dataArray = null;
    let animationFrameId = null;
    let accessToken = null;
    let isAudioOutputEnabled = false; // 禁用语音输出
    let ws = null;
    
    // DOM 元素
    const recordBtn = document.getElementById('record-btn');
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    const voiceLevelIndicator = document.getElementById('voice-level-indicator');
    const voiceLevelText = document.getElementById('voice-level-text');
    const chatContainer = document.getElementById('chat-container');
    const clearBtn = document.getElementById('clear-btn');
    const audioOutputToggle = document.getElementById('audio-output-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const saveSettings = document.getElementById('save-settings');
    const apiKeyInput = document.getElementById('api-key');
    const secretKeyInput = document.getElementById('secret-key');
    const asrEngineSelect = document.getElementById('asr-engine');
    const ttsVoiceSelect = document.getElementById('tts-voice');
    const autoPlayCheckbox = document.getElementById('auto-play');
    const wsUrlInput = document.getElementById('ws-url');
    
    // 模拟语音识别结果池
    const mockRecognitionResults = [
        "今天天气怎么样？",
        "给我讲个笑话吧",
        "帮我查一下附近的餐厅",
        "播放一首流行歌曲",
        "设置一个明天早上7点的闹钟",
        "北京到上海的高铁需要多长时间？",
        "谁是爱因斯坦？",
        "计算一下25乘以36是多少",
        "翻译'你好，世界'到英语",
        "显示当前时间"
    ];
    
    // 初始化设置
    function initSettings() {
        // 从localStorage加载设置
        const savedSettings = localStorage.getItem('baidu-ai-chat-settings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            apiKeyInput.value = settings.apiKey || '';
            secretKeyInput.value = settings.secretKey || '';
            wsUrlInput.value = settings.wsUrl || 'ws://localhost:5000';
            asrEngineSelect.value = settings.asrEngine || 'mock';
            ttsVoiceSelect.value = settings.ttsVoice || 'female';
            autoPlayCheckbox.checked = settings.autoPlay !== undefined ? settings.autoPlay : true;
            isAudioOutputEnabled = settings.audioOutput !== undefined ? settings.audioOutput : true;
        } else {
            // 默认设置
            wsUrlInput.value = 'ws://localhost:5000';
            asrEngineSelect.value = 'mock';
            autoPlayCheckbox.checked = true;
            isAudioOutputEnabled = true;
        }
        
        // 更新UI
        updateAudioOutputButton();
    }
    
    // 保存设置
    function saveAppSettings() {
        const settings = {
            apiKey: apiKeyInput.value,
            secretKey: secretKeyInput.value,
            wsUrl: wsUrlInput.value,
            asrEngine: asrEngineSelect.value,
            ttsVoice: ttsVoiceSelect.value,
            autoPlay: autoPlayCheckbox.checked,
            audioOutput: isAudioOutputEnabled
        };
        
        localStorage.setItem('baidu-ai-chat-settings', JSON.stringify(settings));
    }
    
    // 更新音频输出按钮状态
    function updateAudioOutputButton() {
        if (isAudioOutputEnabled) {
            audioOutputToggle.innerHTML = '<i class="fa fa-volume-up mr-1"></i> 语音输出';
            audioOutputToggle.classList.remove('bg-gray-300');
            audioOutputToggle.classList.add('bg-gray-100');
        } else {
            audioOutputToggle.innerHTML = '<i class="fa fa-volume-off mr-1"></i> 语音输出';
            audioOutputToggle.classList.remove('bg-gray-100');
            audioOutputToggle.classList.add('bg-gray-300');
        }
    }
    
    let recognition;
    function initRecognition() {
        // 检查浏览器支持
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('抱歉，您的浏览器不支持语音识别功能。请使用Chrome、Edge等现代浏览器。');
            return false;
        }
        
        // 创建识别对象
        recognition = new window.webkitSpeechRecognition();
        
        // 配置识别参数
        recognition.continuous = true;  // 连续识别
        recognition.interimResults = true;  // 返回中间结果
        recognition.lang = window.navigator.language;  // 设置语言为中文
        console.log('语音识别已初始化 ', recognition.lang);
        
        // 设置回调函数
        recognition.onstart = () => {
            isRecognizing = true;
            console.log('语音识别已开始。。。');
            // updateStatus('识别中...', 'fa-microphone', 'text-primary');
          
        };
        
        recognition.onresult = (event) => {
            const transcript = [];
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                transcript.push(event.results[i][0].transcript);
                
                // 如果是最终结果
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                    addMessage(finalTranscript, true);
                    // 通过WebSocket发送到后端
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        console.log('发送识别请求:', finalTranscript);
                        ws.send(JSON.stringify({
                            type: 'chat',
                            text: finalTranscript,
                            model: 'ernie-4.5-turbo-32k',
                            api_key: apiKeyInput.value,
                        }));
                        
                        // 添加等待消息
                        addMessage('', false, true);
                        statusText.textContent = '正在发送请求...';
                    } else {
                        showError('WebSocket连接未建立');
                    }
                }
            }
            
            // 更新识别结果
            const interimTranscript = transcript.join('');
            
        };
        
        recognition.onerror = (event) => {
            console.error('语音识别错误:', event.error);
            // updateStatus(`错误: ${event.error}`, 'fa-exclamation-triangle', 'text-red-500');
        };
        
        recognition.onend = () => {
            isRecognizing = false;
            // updateStatus('已停止', 'fa-microphone-slash', 'text-gray-500');
        };
        
        return true;
    }

    // 语音识别
    function recognizeSpeech() {
        if (!recognition) {
            if (!initRecognition()) return;
        }
        isRecording = true;
        recordBtn.innerHTML = '<i class="fa fa-stop text-3xl"></i>';
        recordBtn.classList.remove('bg-primary');
        recordBtn.classList.add('bg-red-500');
        statusIcon.className = 'w-3 h-3 rounded-full bg-green-500 mr-3 animate-pulse';
        statusText.textContent = '正在录音，请说话...';
        
        finalTranscript = '';
        recognition.start();
        
    }
    // 停止识别
    function stopRecognition() {
        if (recognition && isRecognizing) {
            recognition.stop();
            if (!isRecording) return;
        
            isRecording = false;
            
            // 重置录音按钮
            recordBtn.innerHTML = '<i class="fa fa-microphone text-3xl"></i>';
            recordBtn.classList.remove('bg-red-500');
            recordBtn.classList.add('bg-primary');
            console.log('语音识别已停止');
        }
    }

    // 文本转语音
    // 使用浏览器的SpeechSynthesis API进行语音合成
    // 添加语音队列管理
    let speechQueue = [];
    let isSpeaking = false;

    function speakText(text) {
        // 检查是否启用了语音输出
        if (!isAudioOutputEnabled || !('speechSynthesis' in window)) {
            console.log('语音输出已禁用或不支持');
            return;
        }


        if (!('speechSynthesis' in window)) {
            console.error('你的浏览器不支持语音合成API');
            return;
        }
      
        // 创建语音合成话语
        const utterance = new SpeechSynthesisUtterance(text);
        
        // 设置语音属性
        utterance.lang = 'zh-CN';
        utterance.pitch = 1;
        utterance.rate = 1;
        utterance.volume = 1;

        // 添加结束事件处理器
        utterance.onend = () => {
            isSpeaking = false;
            processQueue(); // 处理队列中的下一条语音
        };

        // 添加错误事件处理器
        utterance.onerror = (error) => {
            console.error('语音合成错误:', error);
            isSpeaking = false;
            processQueue(); // 出错时也继续处理队列
        };

        // 将语音添加到队列
        speechQueue.push(utterance);
        
        // 如果当前没有播放，则开始处理队列
        if (!isSpeaking) {
            processQueue();
        }
    }

    // 处理语音队列
    function processQueue() {
        if (speechQueue.length === 0 || isSpeaking) return;

        isSpeaking = true;
        const utterance = speechQueue.shift();
        window.speechSynthesis.speak(utterance);
    }

    // 清空语音队列
    function clearSpeechQueue() {
        speechQueue = [];
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }
        isSpeaking = false;
    }


    
    // 百度TTS语音合成 - 暂时不使用
    async function synthesizeSpeech(text) {
        console.log('语音合成请求:', text);
        // 这里可以保留实际的TTS调用逻辑，但暂时不执行播放
        return null;
    }
    
    // 播放语音 - 暂时禁用
    function playAudio(audioBlob) {
        if (!audioBlob || !isAudioOutputEnabled) return;
        
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.play().catch(e => console.log('语音播放失败:', e));
        
        return audio;
    }
    
    // 添加消息到对话
    function addMessage(text, isUser = false, isStreaming = false) {
        const messageId = generateMessageId();
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start mb-4 mt-2 ' + (isUser ? 'justify-end' : '');
        messageDiv.setAttribute('data-message', 'true');
        messageDiv.setAttribute('data-id', messageId);
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = isUser ? 
            'w-8 h-8 rounded-full bg-secondary/20 flex items-center justify-center text-secondary mr-3 flex-shrink-0' :
            'w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0';
        
        const icon = isUser ? 
            '<i class="fa fa-user"></i>' : 
            '<i class="fas fa-robot"></i>';
        
        avatarDiv.innerHTML = icon;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = isUser ? 
            'bg-secondary/10 text-gray-800 rounded-lg p-3 rounded-tr-none max-w-[80%]' :
            'bg-gray-100 text-gray-800 rounded-lg p-3 rounded-tl-none max-w-[80%]';
        
        contentDiv.setAttribute('data-message-id', messageId);
        
        if (isStreaming) {
            contentDiv.classList.add('streaming-message');
            contentDiv.innerHTML = `<p class="streaming-indicator"><i class="fa fa-circle-o-notch fa-spin mr-2"></i>正在思考...</p>`;
            contentDiv.setAttribute('data-streaming', 'true');
        } else {
            const textP = document.createElement('p');
            textP.textContent = text;
            contentDiv.appendChild(textP);
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // 更新消息状态
        const messageData = {
            id: messageId,
            text: text,
            isUser: isUser,
            isStreaming: isStreaming,
            timestamp: new Date().getTime()
        };
        
        chatState.messages.push(messageData);
        
        if (isStreaming) {
            chatState.currentStream = {
                active: true,
                content: '',
                element: contentDiv,
                messageId: messageId
            };
        }
        
        return contentDiv;
    }
    
    // 更新流式消息
    function updateStreamingMessage(contentDiv, text) {
        if (!contentDiv || !contentDiv.getAttribute('data-streaming')) return;
        
        // 移除加载指示器
        const indicator = contentDiv.querySelector('.streaming-indicator');
        if (indicator) {
            contentDiv.removeChild(indicator);
        }
        
        // 创建或更新内容段落
        let textP = contentDiv.querySelector('p');
        if (!textP) {
            textP = document.createElement('p');
            contentDiv.appendChild(textP);
        }
        
        textP.textContent = text;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // 更新消息状态
        const messageId = contentDiv.getAttribute('data-message-id');
        const messageIndex = chatState.messages.findIndex(m => m.id === messageId);
        if (messageIndex !== -1) {
            chatState.messages[messageIndex].text = text;
        }
    }
    
    // 完成流式消息
    function finishStreamingMessage(contentDiv) {
        if (!contentDiv || !contentDiv.getAttribute('data-streaming')) return;
        
        contentDiv.removeAttribute('data-streaming');
        contentDiv.classList.remove('streaming-message');
        
        // 更新消息状态
        const messageId = contentDiv.getAttribute('data-message-id');
        const messageIndex = chatState.messages.findIndex(m => m.id === messageId);
        if (messageIndex !== -1) {
            chatState.messages[messageIndex].isStreaming = false;
        }
        
        // 重置当前流状态
        if (chatState.currentStream.messageId === messageId) {
            chatState.currentStream = {
                active: false,
                content: '',
                element: null,
                messageId: null
            };
        }
    }
    
    // 处理流式消息的函数
    function handleStreamMessage(text) {
        // 如果没有流式消息，先新建
        if (!chatState.currentStream.active) {
            chatState.currentStream = {
                active: true,
                content: text,
                element: addMessage('', false, true),
                messageId: generateMessageId()
            };
        } else {
            // 找出新增的文本
            if (isAudioOutputEnabled) {
                const currentLength = chatState.currentStream.content.length;
                if (text.length > currentLength) {
                    const newText = text.substring(currentLength);
                    if (newText) {
                        speakText(newText);
                    }
                }
            }
            chatState.currentStream.content = text; // 直接覆盖
        }

        if (chatState.currentStream.element) {
            updateStreamingMessage(chatState.currentStream.element, chatState.currentStream.content);
        }

        statusText.textContent = '正在接收回复...';
    }
    // 处理流式消息结束
    function handleStreamEnd() {
        if (chatState.currentStream.active && chatState.currentStream.element) {
            finishStreamingMessage(chatState.currentStream.element);
            
            // // 播放完整的回复内容
            // if (chatState.currentStream.content) {
            //     speakText(chatState.currentStream.content);
            // }
            
            chatState.currentStream = {
                active: false,
                content: '',
                element: null
            };
            statusText.textContent = '回复已完成';
        }
    }
    
    // 处理完整响应
    function handleFullResponse(text) {
        if (chatState.currentStream.active && chatState.currentStream.element) {
            // 只在有流式消息时覆盖，否则新建
            updateStreamingMessage(chatState.currentStream.element, text);
            finishStreamingMessage(chatState.currentStream.element);
        } else {
            addMessage(text, false);
        }

        chatState.currentStream = {
            active: false,
            content: '',
            element: null,
            messageId: null
        };

        statusText.textContent = '准备就绪，请点击下方按钮开始对话';
    }
    
    // 显示错误消息
    function showError(message) {
        addMessage(`错误: ${message}`, false);
        statusIcon.className = 'w-3 h-3 rounded-full bg-red-500 mr-3 animate-pulse';
        statusText.textContent = '发生错误，请重试';
    }
    
    // 更新语音音量指示器
    function updateVoiceLevel(level) {
        const percentage = Math.min(100, Math.max(0, level * 100));
        voiceLevelIndicator.style.width = `${percentage}%`;
        voiceLevelText.textContent = `音量: ${Math.round(percentage)}`;
    }
    
    // 连接WebSocket
    function connectWebSocket() {
        const wsUrl = wsUrlInput.value;
        
        if (!wsUrl) {
            showError('请在设置中配置WebSocket服务器地址');
            return;
        }
        
        try {
            // 关闭现有连接
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                ws.close();
            }
            
            // 创建新连接
            ws = new WebSocket(wsUrl);
            
            // 连接成功
            ws.onopen = () => {
                statusIcon.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
                statusText.textContent = 'WebSocket连接已建立，准备就绪';
                console.log('WebSocket连接成功:', wsUrl);
            };
            
            // 接收到消息
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'system') {
                    console.log('系统消息:', data.text);
                }
                else if (data.type === 'stream') {
                    handleStreamMessage(data.text);
                }
                else if (data.type === 'stream_end') {
                    handleStreamEnd();
                }
                else if (data.type === 'response') {
                    handleFullResponse(data.text);
                }
            };
            
            // 连接关闭
            ws.onclose = (event) => {
                statusIcon.className = 'w-3 h-3 rounded-full bg-gray-300 mr-3 animate-pulse';
                statusText.textContent = 'WebSocket连接已关闭';
                console.log('WebSocket连接关闭，代码:', event.code, '原因:', event.reason);
                
                // 5秒后尝试重新连接
                setTimeout(() => {
                    if (!isRecording) {
                        connectWebSocket();
                    }
                }, 5000);
            };
            
            // 连接错误
            ws.onerror = (error) => {
                statusIcon.className = 'w-3 h-3 rounded-full bg-red-500 mr-3 animate-pulse';
                statusText.textContent = 'WebSocket连接错误';
                console.error('WebSocket错误:', error);
                showError(`WebSocket连接错误`);
            };
            
        } catch (error) {
            showError(`WebSocket连接失败: ${error.message}`);
            console.error('WebSocket连接失败:', error);
        }
    }
    
    // 清空对话
    function clearChat() {
        chatContainer.innerHTML = `
            <div class="flex items-start">
                <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0">
                    <i class="fa fa-info-circle"></i>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 rounded-tl-none max-w-[80%]">
                    <p class="text-gray-800">欢迎使用百度AI语音对话助手！点击下方麦克风按钮开始语音对话，再次点击停止录音。</p>
                </div>
            </div>
        `;
        
        // 重置消息状态
        chatState = {
            currentStream: {
                active: false,
                content: '',
                element: null,
                messageId: null
            },
            messages: []
        };
        clearSpeechQueue();
    }
    
    // 切换主题
    function toggleTheme() {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        
        if (isDark) {
            themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-400"></i>';
            document.body.classList.add('bg-gray-900', 'text-white');
            document.body.classList.remove('bg-gray-50', 'text-gray-900');
        } else {
            themeToggle.innerHTML = '<i class="fa fa-moon-o text-gray-600"></i>';
            document.body.classList.remove('bg-gray-900', 'text-white');
            document.body.classList.add('bg-gray-50', 'text-gray-900');
        }
    }
    
    // 切换语音输出 - 暂时禁用
    // 修改音频输出按钮事件监听
    audioOutputToggle.addEventListener('click', toggleAudioOutput);

    // 移除按钮的disabled属性
    audioOutputToggle.removeAttribute('disabled');

    function toggleAudioOutput() {
        isAudioOutputEnabled = !isAudioOutputEnabled;
        updateAudioOutputButton();
        
        // 如果禁用，清空当前语音队列
        if (!isAudioOutputEnabled) {
            clearSpeechQueue();
        }
        
        // 保存设置
        saveAppSettings();
    }
    
    // 事件监听器
    function setupEventListeners() {
        // 录音按钮
        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecognition();
            } else {
                recognizeSpeech();
            }
        });
        
        // 清空对话按钮
        clearBtn.addEventListener('click', clearChat);
        
        // 音频输出切换按钮 - 禁用交互
        audioOutputToggle.addEventListener('click', () => {});
        
        // 主题切换按钮
        themeToggle.addEventListener('click', toggleTheme);
        
        // 设置按钮
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
        });
        
        // 关闭设置
        closeSettings.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        
        // 保存设置
        saveSettings.addEventListener('click', () => {
            saveAppSettings();
            settingsModal.classList.add('hidden');
            
            // 如果WebSocket URL改变，重新连接
            if (ws && ws.url !== wsUrlInput.value) {
                connectWebSocket();
            }
            
            showSuccess('设置已保存');
        });
        
        // 点击模态框外部关闭
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });
        
        // ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !settingsModal.classList.contains('hidden')) {
                settingsModal.classList.add('hidden');
            }
        });
    }
    
    // 显示成功消息
    function showSuccess(message) {
        console.log(`Success: ${message}`);
    }
    
    // 初始化应用
    function initApp() {
        initSettings();
        setupEventListeners();
        connectWebSocket();
        // speakText('欢迎使用百度AI语音对话助手！请点击下方麦克风按钮开始对话。');
    }
    
    // 页面加载完成后初始化应用
    window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>