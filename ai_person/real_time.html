<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>百度AI语音对话助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#0FC6C2',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-microphone text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-dark">百度AI语音对话助手</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <i class="fa fa-moon-o text-gray-600"></i>
        </button>
        <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <i class="fa fa-cog text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 状态显示区 -->
    <div class="mb-6 bg-white rounded-lg shadow-sm p-4 flex items-center">
      <div id="status-icon" class="w-3 h-3 rounded-full bg-gray-300 mr-3 animate-pulse"></div>
      <p id="status-text" class="text-gray-600">准备就绪，请点击下方按钮开始对话</p>
    </div>

    <!-- 对话历史 -->
    <div id="chat-container" class="bg-white rounded-lg shadow-sm p-4 mb-6 h-[500px] overflow-y-auto scrollbar-hide">
      <div class="flex flex-col space-y-4">
        <!-- 系统消息 -->
        <div class="flex items-start">
          <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0">
            <i class="fa fa-info-circle"></i>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 rounded-tl-none max-w-[80%]">
            <p class="text-gray-800">欢迎使用百度AI语音对话助手！点击下方麦克风按钮开始语音对话，再次点击停止录音。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 语音输入区域 -->
    <div class="bg-white rounded-lg shadow-sm p-4 flex flex-col space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div id="voice-level" class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
            <div id="voice-level-indicator" class="h-full bg-primary w-0 transition-all duration-150"></div>
          </div>
          <span id="voice-level-text" class="text-sm text-gray-500">音量: 0</span>
        </div>
        <div class="flex items-center space-x-2">
          <button id="clear-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            <i class="fa fa-trash-o mr-1"></i> 清空对话
          </button>
          <button id="audio-output-toggle" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            <i class="fa fa-volume-up mr-1"></i> 语音输出
          </button>
        </div>
      </div>
      
      <div class="flex justify-center">
        <button id="record-btn" class="w-20 h-20 rounded-full bg-primary text-white flex items-center justify-center shadow-lg hover:bg-primary/90 active:scale-95 transition-all">
          <i class="fa fa-microphone text-3xl"></i>
        </button>
      </div>
      
      <div class="text-center text-sm text-gray-500">
        <p>支持中文普通话，说话时请保持适中语速和音量</p>
      </div>
    </div>
  </main>

  <!-- 设置模态框 -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden transform transition-all">
      <div class="bg-primary text-white p-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">设置</h2>
        <button id="close-settings" class="text-white hover:text-gray-200">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">百度API设置</label>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">API Key</label>
              <input id="api-key" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="输入百度API Key">
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Secret Key</label>
              <input id="secret-key" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="输入百度Secret Key">
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">WebSocket设置</label>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">服务器地址</label>
              <input id="ws-url" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="ws://localhost:5000/ws" value="ws://localhost:5000/ws">
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">语音设置</label>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">ASR 引擎</label>
              <select id="asr-engine" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                <option value="baidu">百度ASR</option>
                <option value="other">其他引擎</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">TTS 声音</label>
              <select id="tts-voice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                <option value="female">女声</option>
                <option value="male">男声</option>
                <option value="child">儿童声</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="auto-play" class="mr-2" checked>
            <span>自动播放回复语音</span>
          </label>
        </div>
      </div>
      <div class="bg-gray-50 p-4 flex justify-end">
        <button id="save-settings" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          保存设置
        </button>
      </div>
    </div>
  </div>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2025 百度AI语音对话助手 | 使用百度ASR、TTS和千帆大模型技术</p>
    </div>
  </footer>

  <script>
    // 全局变量
    let isRecording = false;
    let audioContext = null;
    let mediaStream = null;
    let analyser = null;
    let dataArray = null;
    let animationFrameId = null;
    let accessToken = null;
    let isAudioOutputEnabled = true;
    let ws = null;
    
    // DOM 元素
    const recordBtn = document.getElementById('record-btn');
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    const voiceLevelIndicator = document.getElementById('voice-level-indicator');
    const voiceLevelText = document.getElementById('voice-level-text');
    const chatContainer = document.getElementById('chat-container');
    const clearBtn = document.getElementById('clear-btn');
    const audioOutputToggle = document.getElementById('audio-output-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettings = document.getElementById('close-settings');
    const saveSettings = document.getElementById('save-settings');
    const apiKeyInput = document.getElementById('api-key');
    const secretKeyInput = document.getElementById('secret-key');
    const asrEngineSelect = document.getElementById('asr-engine');
    const ttsVoiceSelect = document.getElementById('tts-voice');
    const autoPlayCheckbox = document.getElementById('auto-play');
    const wsUrlInput = document.getElementById('ws-url');
    
    // 初始化设置
    function initSettings() {
      // 从localStorage加载设置
      const savedSettings = localStorage.getItem('baidu-ai-chat-settings');
      if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        apiKeyInput.value = settings.apiKey || '';
        secretKeyInput.value = settings.secretKey || '';
        wsUrlInput.value = settings.wsUrl || 'ws://localhost:5000/ws';
        asrEngineSelect.value = settings.asrEngine || 'baidu';
        ttsVoiceSelect.value = settings.ttsVoice || 'female';
        autoPlayCheckbox.checked = settings.autoPlay !== undefined ? settings.autoPlay : true;
        isAudioOutputEnabled = settings.audioOutput !== undefined ? settings.audioOutput : true;
      }
      
      // 更新UI
      updateAudioOutputButton();
    }
    
    // 保存设置
    function saveAppSettings() {
      const settings = {
        apiKey: apiKeyInput.value,
        secretKey: secretKeyInput.value,
        wsUrl: wsUrlInput.value,
        asrEngine: asrEngineSelect.value,
        ttsVoice: ttsVoiceSelect.value,
        autoPlay: autoPlayCheckbox.checked,
        audioOutput: isAudioOutputEnabled
      };
      
      localStorage.setItem('baidu-ai-chat-settings', JSON.stringify(settings));
    }
    
    // 更新音频输出按钮状态
    function updateAudioOutputButton() {
      if (isAudioOutputEnabled) {
        audioOutputToggle.innerHTML = '<i class="fa fa-volume-up mr-1"></i> 语音输出';
        audioOutputToggle.classList.remove('bg-gray-300');
        audioOutputToggle.classList.add('bg-gray-100');
      } else {
        audioOutputToggle.innerHTML = '<i class="fa fa-volume-off mr-1"></i> 语音输出';
        audioOutputToggle.classList.remove('bg-gray-100');
        audioOutputToggle.classList.add('bg-gray-300');
      }
    }
    
    // 获取百度API访问令牌
    async function getAccessToken() {
      const apiKey = apiKeyInput.value;
      const secretKey = secretKeyInput.value;
      
      if (!apiKey || !secretKey) {
        showError('请先在设置中配置百度API Key和Secret Key');
        return null;
      }
      
      try {
        const response = await fetch(`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${apiKey}&client_secret=${secretKey}`);
        
        if (!response.ok) {
          throw new Error(`获取访问令牌失败: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.access_token;
      } catch (error) {
        showError(`获取访问令牌错误: ${error.message}`);
        return null;
      }
    }
    
    // 百度ASR语音识别
    async function recognizeSpeech(audioBlob) {
      if (!accessToken) {
        accessToken = await getAccessToken();
        if (!accessToken) return null;
      }
      
      // 转换音频为Base64
      const reader = new FileReader();
      reader.readAsDataURL(audioBlob);
      
      return new Promise((resolve, reject) => {
        reader.onloadend = async () => {
          const base64Audio = reader.result.split(',')[1];
          
          try {
            // 调用百度ASR API
            const response = await fetch(`https://vop.baidu.com/server_api?dev_pid=1537&cuid=your_cuid&token=${accessToken}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                format: 'wav',
                rate: 16000,
                channel: 1,
                token: accessToken,
                speech: base64Audio,
                len: audioBlob.size
              })
            });
            
            if (!response.ok) {
              throw new Error(`ASR请求失败: ${response.statusText}`);
            }
            
            const data = await response.json();
            if (data.err_no === 0 && data.result && data.result.length > 0) {
              resolve(data.result[0]);
            } else {
              throw new Error(`ASR识别错误: ${data.err_msg || '未知错误'}`);
            }
          } catch (error) {
            showError(`语音识别错误: ${error.message}`);
            reject(error);
          }
        };
      });
    }
    
    // 百度TTS语音合成
    async function synthesizeSpeech(text) {
      if (!accessToken) {
        accessToken = await getAccessToken();
        if (!accessToken) return null;
      }
      
      try {
        // 构建请求参数
        const voiceMap = {
          female: 0,  // 女声
          male: 1,    // 男声
          child: 3    // 儿童声
        };
        
        const voiceType = voiceMap[ttsVoiceSelect.value] || 0;
        
        // 调用百度TTS API
        const response = await fetch(`https://tsn.baidu.com/text2audio?tex=${encodeURIComponent(text)}&tok=${accessToken}&cuid=your_cuid&ctp=1&lan=zh&per=${voiceType}`, {
          method: 'GET',
          responseType: 'arraybuffer'
        });
        
        if (!response.ok) {
          throw new Error(`TTS请求失败: ${response.statusText}`);
        }
        
        const audioBlob = await response.blob();
        return audioBlob;
      } catch (error) {
        showError(`语音合成错误: ${error.message}`);
        return null;
      }
    }
    
    // 播放语音
    function playAudio(audioBlob) {
      if (!audioBlob) return;
      
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      audio.play();
      
      return audio;
    }
    
    // 添加消息到对话
    function addMessage(text, isUser = false, isStreaming = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start ' + (isUser ? 'justify-end' : '');
      messageDiv.setAttribute('data-message', 'true');
      
      const avatarDiv = document.createElement('div');
      avatarDiv.className = isUser ? 
        'w-8 h-8 rounded-full bg-secondary/20 flex items-center justify-center text-secondary mr-3 flex-shrink-0' :
        'w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0';
      
      const icon = isUser ? 
        '<i class="fa fa-user"></i>' : 
        '<i class="fa fa-robot"></i>';
      
      avatarDiv.innerHTML = icon;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = isUser ? 
        'bg-secondary/10 text-gray-800 rounded-lg p-3 rounded-tr-none max-w-[80%]' :
        'bg-gray-100 text-gray-800 rounded-lg p-3 rounded-tl-none max-w-[80%]';
      
      if (isStreaming) {
        contentDiv.classList.add('streaming-message');
        contentDiv.innerHTML = `<p class="streaming-indicator"><i class="fa fa-circle-o-notch fa-spin mr-2"></i>正在思考...</p>`;
        contentDiv.setAttribute('data-streaming', 'true');
      } else {
        const textP = document.createElement('p');
        textP.textContent = text;
        contentDiv.appendChild(textP);
      }
      
      messageDiv.appendChild(avatarDiv);
      messageDiv.appendChild(contentDiv);
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      return contentDiv;
    }
    
    // 更新流式消息
    function updateStreamingMessage(contentDiv, text) {
      if (!contentDiv || !contentDiv.getAttribute('data-streaming')) return;
      
      // 移除加载指示器
      const indicator = contentDiv.querySelector('.streaming-indicator');
      if (indicator) {
        contentDiv.removeChild(indicator);
      }
      
      // 创建或更新内容段落
      let textP = contentDiv.querySelector('p');
      if (!textP) {
        textP = document.createElement('p');
        contentDiv.appendChild(textP);
      }
      
      textP.textContent = text;
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // 完成流式消息
    function finishStreamingMessage(contentDiv) {
      if (!contentDiv || !contentDiv.getAttribute('data-streaming')) return;
      
      contentDiv.removeAttribute('data-streaming');
      contentDiv.classList.remove('streaming-message');
    }
    
    // 显示错误消息
    function showError(message) {
      addMessage(`错误: ${message}`, false);
      statusIcon.className = 'w-3 h-3 rounded-full bg-red-500 mr-3 animate-pulse';
      statusText.textContent = '发生错误，请重试';
    }
    
    // 更新语音音量指示器
    function updateVoiceLevel(level) {
      const percentage = Math.min(100, Math.max(0, level * 100));
      voiceLevelIndicator.style.width = `${percentage}%`;
      voiceLevelText.textContent = `音量: ${Math.round(percentage)}`;
    }
    
    // 连接WebSocket
    function connectWebSocket() {
      const wsUrl = wsUrlInput.value;
      
      if (!wsUrl) {
        showError('请在设置中配置WebSocket服务器地址');
        return;
      }
      
      try {
        // 关闭现有连接
        if (ws && ws.readyState !== WebSocket.CLOSED) {
          ws.close();
        }
        
        // 创建新连接
        ws = new WebSocket(wsUrl);
        
        // 连接成功
        ws.onopen = () => {
          statusIcon.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
          statusText.textContent = 'WebSocket连接已建立，准备就绪';
          console.log('WebSocket连接成功');
        };
        
        // 接收到消息
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'system') {
              // 系统消息
              console.log('系统消息:', data.message);
            } else if (data.type === 'response') {
              // 完整回复
              const contentDiv = document.querySelector('.streaming-message p')?.parentElement;
              
              if (contentDiv && contentDiv.getAttribute('data-streaming')) {
                // 更新现有流式消息
                updateStreamingMessage(contentDiv, data.text);
                finishStreamingMessage(contentDiv);
              } else {
                // 添加新消息
                addMessage(data.text, false);
              }
              
              statusText.textContent = '准备就绪，请点击下方按钮开始对话';
              
              // 如果启用了语音输出，播放回复
              if (isAudioOutputEnabled && autoPlayCheckbox.checked) {
                statusText.textContent = '正在合成语音...';
                synthesizeSpeech(data.text).then(speechBlob => {
                  if (speechBlob) {
                    statusText.textContent = '正在播放语音...';
                    const audio = playAudio(speechBlob);
                    audio.onended = () => {
                      statusText.textContent = '准备就绪，请点击下方按钮开始对话';
                    };
                  }
                });
              }
            } else if (data.type === 'stream') {
              // 流式回复
              const contentDiv = document.querySelector('.streaming-message p')?.parentElement;
              
              if (contentDiv && contentDiv.getAttribute('data-streaming')) {
                // 更新现有流式消息
                updateStreamingMessage(contentDiv, data.text);
              } else {
                // 创建新的流式消息
                const newContentDiv = addMessage('', false, true);
                updateStreamingMessage(newContentDiv, data.text);
              }
              
              statusText.textContent = '正在接收回复...';
            }
          } catch (error) {
            console.error('处理WebSocket消息出错:', error);
            showError(`接收消息错误: ${error.message}`);
          }
        };
        
        // 连接关闭
        ws.onclose = (event) => {
          statusIcon.className = 'w-3 h-3 rounded-full bg-gray-300 mr-3 animate-pulse';
          statusText.textContent = 'WebSocket连接已关闭';
          console.log('WebSocket连接关闭，代码:', event.code, '原因:', event.reason);
          
          // 5秒后尝试重新连接
          setTimeout(() => {
            if (!isRecording) {
              connectWebSocket();
            }
          }, 5000);
        };
        
        // 连接错误
        ws.onerror = (error) => {
          statusIcon.className = 'w-3 h-3 rounded-full bg-red-500 mr-3 animate-pulse';
          statusText.textContent = 'WebSocket连接错误';
          console.error('WebSocket错误:', error);
          showError(`WebSocket连接错误`);
        };
        
      } catch (error) {
        showError(`WebSocket连接失败: ${error.message}`);
        console.error('WebSocket连接失败:', error);
      }
    }
    
    // 开始录音
    async function startRecording() {
      if (isRecording) return;
      
      try {
        // 检查WebSocket连接
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          connectWebSocket();
          // 等待连接建立
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            throw new Error('WebSocket连接未建立');
          }
        }
        
        // 重置访问令牌
        accessToken = null;
        
        // 获取麦克风权限
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // 创建音频上下文
        if (!audioContext || audioContext.state === 'closed') {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // 创建音频分析器
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        // 连接音频源到分析器
        const source = audioContext.createMediaStreamSource(mediaStream);
        source.connect(analyser);
        
        // 开始录制
        isRecording = true;
        recordBtn.innerHTML = '<i class="fa fa-stop text-3xl"></i>';
        recordBtn.classList.remove('bg-primary');
        recordBtn.classList.add('bg-red-500');
        statusIcon.className = 'w-3 h-3 rounded-full bg-green-500 mr-3 animate-pulse';
        statusText.textContent = '正在录音，请说话...';
        
        // 创建录音器
        const mediaRecorder = new MediaRecorder(mediaStream);
        const audioChunks = [];
        
        mediaRecorder.addEventListener('dataavailable', (event) => {
          audioChunks.push(event.data);
        });
        
        mediaRecorder.addEventListener('stop', async () => {
          isRecording = false;
          cancelAnimationFrame(animationFrameId);
          
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          
          // 更新UI状态
          recordBtn.innerHTML = '<i class="fa fa-microphone text-3xl"></i>';
          recordBtn.classList.remove('bg-red-500');
          recordBtn.classList.add('bg-primary');
          statusIcon.className = 'w-3 h-3 rounded-full bg-blue-500 mr-3 animate-pulse';
          statusText.textContent = '正在识别语音...';
          
          try {
            // 识别语音
            const recognizedText = await recognizeSpeech(audioBlob);
            
            if (recognizedText) {
              // 添加用户消息到对话
              addMessage(recognizedText, true);
              
              // 通过WebSocket发送到后端
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                  type: 'chat',
                  text: recognizedText,
                  model: 'ernie-bot' // 可以从设置中选择模型
                }));
                
                // 添加等待消息
                addMessage('', false, true);
                statusText.textContent = '正在发送请求...';
              } else {
                showError('WebSocket连接未建立');
              }
            }
          } catch (error) {
            showError(`处理语音错误: ${error.message}`);
          }
        });
        
        // 开始录制
        mediaRecorder.start();
        
        // 监听音频音量
        function updateVolume() {
          analyser.getByteFrequencyData(dataArray);
          let sum = 0;
          
          // 计算平均音量
          for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i];
          }
          
          const average = sum / dataArray.length;
          const normalizedLevel = average / 255;
          
          // 更新音量指示器
          updateVoiceLevel(normalizedLevel);
          
          // 继续监听
          if (isRecording) {
            animationFrameId = requestAnimationFrame(updateVolume);
          }
        }
        
        // 开始监听音量
        updateVolume();
        
        // 30秒后自动停止录音
        setTimeout(() => {
          if (isRecording) {
            stopRecording();
          }
        }, 30000);
        
      } catch (error) {
        showError(`录音错误: ${error.message}`);
      }
    }
    
    // 停止录音
    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      cancelAnimationFrame(animationFrameId);
      
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
    }
    
    // 清空对话
    function clearChat() {
      chatContainer.innerHTML = `
        <div class="flex items-start">
          <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-3 flex-shrink-0">
            <i class="fa fa-info-circle"></i>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 rounded-tl-none max-w-[80%]">
            <p class="text-gray-800">欢迎使用百度AI语音对话助手！点击下方麦克风按钮开始语音对话，再次点击停止录音。</p>
          </div>
        </div>
      `;
    }
    
    // 切换主题
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      
      if (isDark) {
        themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-400"></i>';
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-gray-50', 'text-gray-900');
      } else {
        themeToggle.innerHTML = '<i class="fa fa-moon-o text-gray-600"></i>';
        document.body.classList.remove('bg-gray-900', 'text-white');
        document.body.classList.add('bg-gray-50', 'text-gray-900');
      }
    }
    
    // 切换语音输出
    function toggleAudioOutput() {
      isAudioOutputEnabled = !isAudioOutputEnabled;
      updateAudioOutputButton();
      saveAppSettings();
    }
    
    // 事件监听器
    function setupEventListeners() {
      // 录音按钮
      recordBtn.addEventListener('click', () => {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      });
      
      // 清空对话按钮
      clearBtn.addEventListener('click', clearChat);
      
      // 音频输出切换按钮
      audioOutputToggle.addEventListener('click', toggleAudioOutput);
      
      // 主题切换按钮
      themeToggle.addEventListener('click', toggleTheme);
      
      // 设置按钮
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.remove('hidden');
      });
      
      // 关闭设置
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.add('hidden');
      });
      
      // 保存设置
      saveSettings.addEventListener('click', () => {
        saveAppSettings();
        settingsModal.classList.add('hidden');
        
        // 如果WebSocket URL改变，重新连接
        if (ws && ws.url !== wsUrlInput.value) {
          connectWebSocket();
        }
        
        showSuccess('设置已保存');
      });
      
      // 点击模态框外部关闭
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.add('hidden');
        }
      });
      
      // ESC键关闭模态框
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !settingsModal.classList.contains('hidden')) {
          settingsModal.classList.add('hidden');
        }
      });
    }
    
    // 显示成功消息
    function showSuccess(message) {
      // 这里可以实现一个toast提示
      console.log(`Success: ${message}`);
    }
    
    // 初始化应用
    function initApp() {
      initSettings();
      setupEventListeners();
      connectWebSocket();
    }
    
    // 页面加载完成后初始化应用
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
    